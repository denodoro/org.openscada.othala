<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     OpenSCADA Setup Builder
                   
     Jens Reimann                                                                
     ====================================================================== -->
<project name="OpenSCADA Setup Builder" default="default" basedir=".">
    <description>
    	OpenSCADA Setup Builder
    </description>
	
	<!-- properties -->
	<property file="build.properties"/>
	<property file="local.properties"/>
	
	<property name="platformName" value="win32.win32.x86"/>
	<property name="advinst.base" location="/home/user/AdvancedInstaller"/>
	
	<property name="hudson.project.name" value="OpenSCADA-Atlantis-PDE"/>
	<property name="hudson.uri" value="http://192.168.1.60:8080/hudson"/>
	<property name="hudson.artifacts.base" value="job/${hudson.project.name}/lastSuccessfulBuild/artifact"/>
	
	<property name="deploy.base" location="${java.io.tmpdir}/deploy-msi"/>
	
	<!-- ================================= 
          target: default              
         ================================= -->
    <target name="default" depends="clean" description="Build the setup">
    	<mkdir dir="${deploy.base}"/>
    	
		<clean/>
    	<download module="ostc"/>
    	<build module="ostc"/>
    </target>
	
	<!-- ================================= 
          target: clean              
         ================================= -->
    <target name="clean" depends="" description="Clean up">
    	<delete dir="${deploy.base}"/>
    </target>


	<!-- = = = = = = = = = = = = = = = = =
          macrodef: clean          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="clean">
        <sequential>
        	<delete dir="${basedir}/temp/"/>
	    	<delete dir="${basedir}/unpack/"/>
	    	<delete failonerror="false">
	    		<fileset dir="${basedir}">
	    			<include name="**/*.msi"/>
	    		</fileset>
	    	</delete>    
        </sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: build          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="build">
        <attribute name="module"/>
        <sequential>
        	<echo message="Setting version to ${version}"/>
        	<exec executable="${advinst.base}/AdvancedInstaller.com" dir="." failonerror="true">
	    		<arg value="/edit"/>
	    		<arg value="@{module}_setup.aip"/>
	    		<arg value="/SetVersion"/>
	    		<arg value="${version}"/>
	    	</exec>
	    	<exec executable="${advinst.base}/AdvancedInstaller.com" dir="." failonerror="true">
	    		<arg value="/build"/>
	    		<arg value="@{module}_setup.aip"/>
	    	</exec>
        	<move todir="${deploy.base}">
        		<fileset dir=".">
        			<include name="**/*.msi"/>
        		</fileset>
        	</move>
        </sequential>
    </macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: download          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="download">
        <attribute name="module"/>
        <sequential>
        	<mkdir dir="${basedir}/temp/"/>
	        <get src="${hudson.uri}/${hudson.artifacts.base}/deploy/deploy/@{module}/Integration-${platformName}.zip" dest="${basedir}/temp/${platformName}.zip"/>
	    	<mkdir dir="${basedir}/unpack/"/>
	    	<unzip src="${basedir}/temp/${platformName}.zip" dest="${basedir}/unpack">
	    	</unzip>
        </sequential>
    </macrodef>
	
</project>